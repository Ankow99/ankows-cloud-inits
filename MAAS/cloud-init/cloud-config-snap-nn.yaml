## template: jinja
#cloud-config
ssh_import_id: ['lp:pgdg99']
ssh_genkeytypes: [ed25519]

write_files:
- path: /etc/profile.d/maas-login.sh
  permissions: '0644'
  content: |
    if [ "$USER" = "ubuntu" ] && command -v maas >/dev/null 2>&1; then
        ADMIN_USER="admin"
        maas login $ADMIN_USER 'http://localhost:5240/MAAS/' $(sudo maas apikey --username $ADMIN_USER) >/dev/null 2>&1
    fi

- path: /etc/profile.d/default-editor.sh
  permissions: '0644'
  content: |
    export EDITOR=nvim

- path: /etc/sudoers.d/keep-editor
  permissions: '0440'
  content: |
    Defaults env_keep += "EDITOR"

packages:
  - git
  - neovim
  - pollinate
  - jq
  
snap:
  commands:
  - snap install maas --channel=3.6/stable
  - snap install maas-test-db

package_update: true
package_upgrade: true
package_reboot_if_required: true

timezone: America/Bogota

random_seed:
  command: [pollinate]
  command_required: true
  file: /dev/urandom

runcmd:

# Export variables
- echo -e "\n-------- Exporting variables... --------\n"

- export SSH_KEY=lp:pgdg99

- export ADMIN_USER=admin
- export ADMIN_PASS=admin
- export ADMIN_EMAIL=admin@mail.com

- export GATEWAY=10.0.0.1
- export SUBNET=10.0.0.0/22

- export MAAS_PROJECT_NAME=maas
- export MAAS_DNS=8.8.8.8
- export MAAS_RESERVED_IP_START=10.0.3.200
- export MAAS_RESERVED_IP_END=10.0.3.254

- export NODE_CPU=2
- export NODE_RAM=4096
- export NODE_MAIN_DISK=20

- export IP_ADDRESS=$(ip -j route show default | jq -r '.[].prefsrc')
- export INTERFACE=$(ip -j route show default | jq -r '.[].dev')

# Initialise MAAS
- echo -e "\n-------- Initializing MAAS... --------\n"

- maas init region+rack --database-uri maas-test-db:/// --maas-url http://${IP_ADDRESS}:5240/MAAS
- maas createadmin --username $ADMIN_USER --password $ADMIN_PASS --email $ADMIN_EMAIL

# Wait for MAAS services to be ready
- |
  echo -e "\n-------- Waiting for MAAS API to be ready... --------\n"
  
  until maas login $ADMIN_USER 'http://localhost:5240/MAAS/' $(maas apikey --username $ADMIN_USER) > /dev/null 2>&1; do
    echo "MAAS is not ready yet (502). Retrying in 30 seconds..."
    sleep 30
  done

# Grab API key and login as admin
- echo -e "\n-------- Logging in as admin user... --------\n"

- export APIKEY=$(maas apikey --username $ADMIN_USER)
- maas login $ADMIN_USER 'http://localhost:5240/MAAS/' $APIKEY

- maas $ADMIN_USER maas set-config name=maas_name value=$MAAS_PROJECT_NAME name=completed_intro value=true

# Automatically create and add ssh keys to MAAS
- echo -e "\n-------- Generating SSH keys and adding them to MAAS... --------\n"

- ssh-keygen -q -t rsa -N "" -f "/home/ubuntu/.ssh/id_rsa"
- chown ubuntu:ubuntu /home/ubuntu/.ssh/id_rsa /home/ubuntu/.ssh/id_rsa.pub
- chmod 600 /home/ubuntu/.ssh/id_rsa
- chmod 644 /home/ubuntu/.ssh/id_rsa.pub
- maas $ADMIN_USER sshkeys create key="$(cat /home/ubuntu/.ssh/id_rsa.pub)"

# Configure MAAS networking (set gateways, vlans, DHCP on etc)
- echo -e "\n-------- Configuring MAAS networking... --------\n"

- export FABRIC_ID=$(maas $ADMIN_USER subnet read "$SUBNET" | jq -r ".vlan.fabric_id")
- export VLAN_TAG=$(maas $ADMIN_USER subnet read "$SUBNET" | jq -r ".vlan.vid")
- export PRIMARY_RACK=$(maas $ADMIN_USER rack-controllers read | jq -r ".[] | .system_id")

- maas $ADMIN_USER subnet update $SUBNET gateway_ip=$GATEWAY
- maas $ADMIN_USER ipranges create type=dynamic start_ip=$MAAS_RESERVED_IP_START end_ip=$MAAS_RESERVED_IP_END
- maas $ADMIN_USER vlan update $FABRIC_ID $VLAN_TAG dhcp_on=true primary_rack=$PRIMARY_RACK
- maas $ADMIN_USER maas set-config name=upstream_dns value=$MAAS_DNS

# Configure boot images
- echo -e "\n-------- Configuring MAAS boot images... --------\n"

- export BOOT_SOURCE_ID=$(maas $ADMIN_USER boot-sources read | jq -r '.[0].id')

- maas $ADMIN_USER boot-source-selections create $BOOT_SOURCE_ID os="ubuntu" release="noble" arches="amd64" labels='*' subarches='*'
- maas $ADMIN_USER boot-source-selections create $BOOT_SOURCE_ID os="ubuntu" release="jammy" arches="amd64" labels='*' subarches='*'

- maas $ADMIN_USER boot-resources import

# Wait for MAAS boot images to be ready
- sleep 90

# Install Packer
#- echo -e "\n-------- Installing Packer... --------\n"

#- wget -O - https://apt.releases.hashicorp.com/gpg | gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
#- echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | tee /etc/apt/sources.list.d/hashicorp.list

#- apt-get update
#- apt-get install -y packer make qemu-utils libnbd-bin nbdkit fuse2fs qemu-system qemu-system-modules-spice ovmf cloud-image-utils parted

# Create custom Image using Packer
#- echo -e "\n-------- Creating Custom MAAS Image using Packer... --------\n"

#- git clone https://github.com/canonical/packer-maas.git /home/ubuntu/packer-maas/
#- su -l ubuntu -c 'sudo make -C ~/packer-maas/ubuntu/ custom-cloudimg.tar.gz'
#- mv /home/ubuntu/packer-maas/ubuntu/custom-cloudimg.tar.gz /home/ubuntu
#- chown ubuntu:ubuntu /home/ubuntu/custom-cloudimg.tar.gz

# Add custom image to MAAS
#- echo -e "\n-------- Adding Custom Image to MAAS... --------\n"

#- su ubuntu -c "maas login $ADMIN_USER 'http://localhost:5240/MAAS/' $APIKEY && maas $ADMIN_USER boot-resources create name='custom/ubuntu-tgz' title='Ubuntu Custom TGZ' architecture='amd64/generic' filetype='tgz' content@='/home/ubuntu/custom-cloudimg.tar.gz'"

# Add LXD as a VM host for MAAS
- echo -e "\n-------- Adding LXD as VM host in MAAS... --------\n"

- maas $ADMIN_USER vm-hosts create type=lxd power_address=https://192.168.1.68:8443 password=thinkpadp16-lxd name=LXD project=$MAAS_PROJECT_NAME
- export VM_HOST_ID=$(maas $ADMIN_USER vm-hosts read | jq -r '.[0].id')

# Compose VMs using VM host (-c limits.cpu=6 -c limits.memory=12GiB --device root,size=60GiB)
- echo -e "\n-------- Composing VM(s) using LXD... --------\n"

- export SYSTEM_ID_1=$(maas $ADMIN_USER vm-host compose $VM_HOST_ID cores=$NODE_CPU memory=$NODE_RAM storage=$NODE_MAIN_DISK hostname=node1 | jq -r '.system_id')

- export SYSTEM_ID_2=$(maas $ADMIN_USER vm-host compose $VM_HOST_ID cores=$NODE_CPU memory=$NODE_RAM storage=$NODE_MAIN_DISK hostname=node2 | jq -r '.system_id')

- export SYSTEM_ID_3=$(maas $ADMIN_USER vm-host compose $VM_HOST_ID cores=$NODE_CPU memory=$NODE_RAM storage=$NODE_MAIN_DISK hostname=node3 | jq -r '.system_id')

# Wait for VMs to be ready
- |
  echo "Waiting for VMs to enter 'Ready' state..."
  
  # Aggregate the IDs from your previous exports
  IDS="$SYSTEM_ID_1 $SYSTEM_ID_2 $SYSTEM_ID_3"
  
  # Safety check: Ensure we actually have IDs to check
  if [ -z "$(echo "$IDS" | tr -d ' ')" ]; then
    echo "Error: No System IDs found. Exports may not have persisted."
    exit 1
  fi

  # Start the loop
  while true; do
    all_ready=true
    
    for id in $IDS; do
      # Query MAAS for the status name (requires jq)
      status=$(maas $ADMIN_USER machine read "$id" | jq -r '.status_name')
      echo "  Machine $id is currently '$status'..."
      # If any machine is NOT ready, we mark the flag as false
      if [ "$status" != "Ready" ]; then
         all_ready=false
      fi
    done

    # If the flag is still true, everyone is ready -> break the loop
    if [ "$all_ready" = true ]; then
      echo "All VMs are Ready!"
      break
    fi

    # Wait 30 seconds before checking again
    echo "Waiting 60s before checking again..."
    sleep 60
  done

# Deploy VMs using VM host
#- echo -e "\n-------- Deploying VM(s)... --------\n"

#- maas $ADMIN_USER machine deploy $SYSTEM_ID_1 distro_series=ubuntu/noble ephemeral_deploy=false
#- maas $ADMIN_USER machine deploy $SYSTEM_ID_2 distro_series=ubuntu/jammy ephemeral_deploy=false

